name: _Test_Container

on:
  workflow_call:
    inputs:
      os:
        description: 'OS to test'
        required: false
        type: string
        default: ubuntu-latest
      container:
        description: 'Docker image to use (optional, e.g., rockylinux:9)'
        required: true
        type: string
      version:
        description: 'CUDA version to test'
        required: true
        type: string
      method:
        description: 'Method to test'
        required: true
        type: string
      debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

jobs:
  TestContainer:
    runs-on: ${{ inputs.os }}
    container:
      image: ${{ inputs.container }}
      volumes:
        - /usr/share/dotnet:/usr/share/dotnet
        - /usr/local/lib/android:/usr/local/lib/android
    env:
      ACTIONS_STEP_DEBUG: ${{ inputs.debug }}
      ACTIONS_RUNNER_DEBUG: ${{ inputs.debug }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Install System Dependencies (Container)
        shell: bash
        run: |
          # POSIX-compatible redirection so it works even without bash
          if command -v dnf >/dev/null 2>&1; then
            echo "dnf found"
            dnf install -y --allowerasing libxml2 wget gcc gcc-c++ make curl sudo git
          elif command -v yum >/dev/null 2>&1; then
            echo "yum found"
            yum install -y libxml2 wget gcc gcc-c++ make curl sudo git
          elif command -v apt-get >/dev/null 2>&1; then
            echo "apt-get found"
            apt-get update
            apt-get install -y libxml2 curl wget build-essential sudo git
          fi

      - name: Show Container Information
        run: |
          df -h || true
          echo "-------"
          cat /proc/cpuinfo || true
          echo "-------"
          cat /etc/os-release || true
          echo "-------"
          free -h || true

      - name: Expand Disk Space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          echo "-------"
          df -h

      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Test Local Action
        id: setup-cuda
        uses: ./
        with:
          version: ${{ inputs.version }}
          method: ${{ inputs.method }}

      - name: Verify CUDA Installation (Linux)
        shell: bash
        run: |
          echo "CUDA Version: ${{ steps.setup-cuda.outputs.version }}"
          echo "CUDA Path: ${{ steps.setup-cuda.outputs.cuda-path }}"

          echo "PATH: $PATH"

          # Check if CUDA_PATH is set
          if [ -z "$CUDA_PATH" ]; then
            echo "Error: CUDA_PATH is not set"
            exit 1
          fi
          ls $CUDA_PATH
          ls $CUDA_PATH/bin

          # Check if nvcc exists
          if command -v nvcc &> /dev/null; then
            echo "nvcc found at: $(which nvcc)"
            nvcc --version
          else
            echo "Error: nvcc not found in PATH"
            exit 1
          fi

          # Verify CUDA path exists
          if [ ! -d "$CUDA_PATH" ]; then
            echo "Error: CUDA path does not exist: $CUDA_PATH"
            exit 1
          fi

          echo "CUDA installation verified successfully"

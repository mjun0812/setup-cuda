name: Test

on:
  workflow_call:
    inputs:
      os:
        description: 'OS to test'
        required: true
        type: string
      version:
        description: 'CUDA version to test'
        required: true
        type: string

jobs:
  Test:
    name: Test (${{ inputs.os }}, CUDA ${{ inputs.version }})
    runs-on: ${{ inputs.os }}

    steps:
      - name: Expand Disk Space
        if: runner.os == 'Linux'
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          echo "-------"
          df -h

      - name: Expand Disk Space
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-PSDrive -PSProvider FileSystem | Format-Table
          if (Test-Path "C:\Program Files\dotnet") {
            Remove-Item -Recurse -Force "C:\Program Files\dotnet" -ErrorAction SilentlyContinue
          }
          if (Test-Path "C:\Program Files (x86)\dotnet") {
            Remove-Item -Recurse -Force "C:\Program Files (x86)\dotnet" -ErrorAction SilentlyContinue
          }
          if (Test-Path "C:\Program Files (x86)\Android") {
            Remove-Item -Recurse -Force "C:\Program Files (x86)\Android" -ErrorAction SilentlyContinue
          }
          Write-Host "-------"
          Get-PSDrive -PSProvider FileSystem | Format-Table

      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Test Local Action
        id: setup-cuda
        uses: ./
        with:
          version: ${{ inputs.version }}

      - name: Verify CUDA Installation
        shell: bash
        run: |
          echo "CUDA Version: ${{ steps.setup-cuda.outputs.version }}"
          echo "CUDA Path: ${{ steps.setup-cuda.outputs.cuda-path }}"

          # Check if CUDA_PATH is set
          if [ -z "$CUDA_PATH" ]; then
            echo "Error: CUDA_PATH is not set"
            exit 1
          fi

          # Check if nvcc exists
          if command -v nvcc &> /dev/null; then
            echo "nvcc found at: $(which nvcc)"
            nvcc --version
          else
            echo "Error: nvcc not found in PATH"
            exit 1
          fi

          # Verify CUDA path exists
          if [ ! -d "$CUDA_PATH" ]; then
            echo "Error: CUDA path does not exist: $CUDA_PATH"
            exit 1
          fi

          echo "CUDA installation verified successfully"

name: _Test

on:
  workflow_call:
    inputs:
      os:
        description: 'OS to test'
        required: true
        type: string
      container:
        description: 'Docker image to use (optional, e.g., rockylinux:9)'
        required: false
        type: string
        default: ''
      version:
        description: 'CUDA version to test'
        required: true
        type: string
      method:
        description: 'Method to test'
        required: true
        type: string
      debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

jobs:
  Test:
    runs-on: ${{ inputs.os }}
    container: ${{ inputs.container || null }}
    env:
      ACTIONS_STEP_DEBUG: ${{ inputs.debug }}
      ACTIONS_RUNNER_DEBUG: ${{ inputs.debug }}

    steps:
      - name: Expand Disk Space
        if: runner.os == 'Linux' && !inputs.container
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          echo "-------"
          df -h

      - name: Install System Dependencies (Container)
        if: inputs.container
        run: |
          if command -v dnf &> /dev/null; then
            dnf install -y libxml2 curl wget gcc gcc-c++ make
          elif command -v yum &> /dev/null; then
            yum install -y libxml2 curl wget gcc gcc-c++ make
          elif command -v apt-get &> /dev/null; then
            apt-get update
            apt-get install -y libxml2 curl wget build-essential
          fi

      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Test Local Action
        id: setup-cuda
        uses: ./
        with:
          version: ${{ inputs.version }}
          method: ${{ inputs.method }}

      - name: Verify CUDA Installation (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "CUDA Version: ${{ steps.setup-cuda.outputs.version }}"
          echo "CUDA Path: ${{ steps.setup-cuda.outputs.cuda-path }}"

          echo "PATH: $PATH"

          # Check if CUDA_PATH is set
          if [ -z "$CUDA_PATH" ]; then
            echo "Error: CUDA_PATH is not set"
            exit 1
          fi
          ls $CUDA_PATH
          ls $CUDA_PATH/bin

          # Check if nvcc exists
          if command -v nvcc &> /dev/null; then
            echo "nvcc found at: $(which nvcc)"
            nvcc --version
          else
            echo "Error: nvcc not found in PATH"
            exit 1
          fi

          # Verify CUDA path exists
          if [ ! -d "$CUDA_PATH" ]; then
            echo "Error: CUDA path does not exist: $CUDA_PATH"
            exit 1
          fi

          echo "CUDA installation verified successfully"

      - name: Verify CUDA Installation (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Write-Host "CUDA Version: ${{ steps.setup-cuda.outputs.version }}"
          Write-Host "CUDA Path: ${{ steps.setup-cuda.outputs.cuda-path }}"

          Write-Host "PATH: $env:PATH"

          # Check if CUDA_PATH is set
          if (-not $env:CUDA_PATH) {
            Write-Error "Error: CUDA_PATH is not set"
            exit 1
          }

          # Check if nvcc exists
          if (Get-Command nvcc -ErrorAction SilentlyContinue) {
            Write-Host "nvcc found at: $((Get-Command nvcc).Source)"
            nvcc --version
          } else {
            Write-Error "Error: nvcc not found in PATH"
            exit 1
          }

          # Verify CUDA path exists
          if (-not (Test-Path $env:CUDA_PATH)) {
            Write-Error "Error: CUDA path does not exist: $env:CUDA_PATH"
            exit 1
          }

          Write-Host "CUDA installation verified successfully"

      - name: Verify CUDA Installation
        shell: bash
        run: |
          echo "CUDA Version: ${{ steps.setup-cuda.outputs.version }}"
          echo "CUDA Path: ${{ steps.setup-cuda.outputs.cuda-path }}"

          echo "PATH: $PATH"

          # Check if CUDA_PATH is set
          if [ -z "$CUDA_PATH" ]; then
            echo "Error: CUDA_PATH is not set"
            exit 1
          fi

          # Check if nvcc exists
          if command -v nvcc &> /dev/null; then
            echo "nvcc found at: $(which nvcc)"
            nvcc --version
          else
            echo "Error: nvcc not found in PATH"
            exit 1
          fi

          # Verify CUDA path exists
          if [ ! -d "$CUDA_PATH" ]; then
            echo "Error: CUDA path does not exist: $CUDA_PATH"
            exit 1
          fi

          echo "CUDA installation verified successfully"
